openapi: "3.0.0"
info:
  version: 1.0.0
  title: Kanda Service - API schema
  description: Kanda Service API Schema

servers:
  - url: https://hub.kanda.co.uk
  - url: https://hub-qa.kanda.co.uk
  - url: http://localhost:8080

paths:
  /api/me:
    get:
      operationId: me
      summary: Get Me info
      tags:
        - AuthUser
      responses:
        200:
          description: Me info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthUser"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/company:
    get:
      operationId: getCompanies
      summary: Get all companies
      tags:
        - Company
      responses:
        200:
          description: Got all companies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Company"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      operationId: postCompany
      summary: Post new Company
      tags:
        - Company
      requestBody:
        description: post new company object
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Company"
      responses:
        200:
          description: Posted company object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Company"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/company/{id}:
    get:
      operationId: getCompany
      summary: get existing Company
      tags:
        - Company
      parameters:
        - name: id
          in: path
          description: company id
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        200:
          description: Got company object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Company"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      operationId: putCompany
      summary: put existing Company
      tags:
        - Company
      parameters:
        - name: id
          in: path
          description: company id
          required: true
          schema:
            type: string
            minLength: 1
      requestBody:
        description: put existing company object
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Company"
      responses:
        200:
          description: Put company object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Company"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      operationId: deleteCompany
      summary: delete existing Company
      tags:
        - Company
      parameters:
        - name: id
          in: path
          description: company id
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        200:
          description: Deleted company object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Company"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/job:
    get:
      operationId: getJobs
      summary: Get all jobs
      tags:
        - Job
      responses:
        200:
          description: Got all jobs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Job"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      operationId: postJob
      summary: Post new Job
      tags:
        - Job
      requestBody:
        description: post new job object
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Job"
      responses:
        200:
          description: Posted job object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/job/{id}:
    get:
      operationId: getJob
      summary: get existing Job
      tags:
        - Job
      parameters:
        - name: id
          in: path
          description: job id
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        200:
          description: Got job object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      operationId: putJob
      summary: put existing Job
      tags:
        - Job
      parameters:
        - name: id
          in: path
          description: job id
          required: true
          schema:
            type: string
            minLength: 1
      requestBody:
        description: put existing job object
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Job"
      responses:
        200:
          description: Put job object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      operationId: deleteJob
      summary: delete existing Job
      tags:
        - Job
      parameters:
        - name: id
          in: path
          description: job id
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        200:
          description: Deleted job object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Job"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  schemas:
    AuthUser:
      type: object
      required:
        - id
        - token
        - name
        - email
        - provider
        - subject
        - audience
        - issuer
      properties:
        id:
          type: string
          title: id
          readOnly: true
        token:
          type: string
          title: token
          readOnly: true
        name:
          type: string
          title: name
          minLength: 1
        email:
          type: string
          title: email
          format: email
          readOnly: true
        role:
          type: string
          title: role
          readOnly: true
        phone:
          type: string
          title: phone
          minLength: 1
        photoURL:
          type: string
          title: photo URL
          format: uri
        disabled:
          type: boolean
          title: disabled
          readOnly: true
        provider:
          type: string
          title: provider
          readOnly: true
        subject:
          type: string
          title: subject
          readOnly: true
        audience:
          type: string
          title: audience
          readOnly: true
        issuer:
          type: string
          title: issuer
          readOnly: true

    Metadata:
      type: object
      required:
        - liveness
        - created_at
        - updated_at
      properties:
        liveness:
          type: boolean
          title: liveness
          readOnly: true
        created_at:
          type: string
          format: date-time
          title: created at
          readOnly: true
        updated_at:
          type: string
          format: date-time
          title: updated at
          readOnly: true

    Address:
      type: object
      required:
        - line_1
        - city
        - country
        - postcode
      properties:
        building_number:
          type: string
          title: building number
          minLength: 1
        building_name:
          type: string
          title: building name
          minLength: 1
        line_1:
          type: string
          title: line 1
          minLength: 1
        line_2:
          type: string
          title: line 2
          minLength: 1
        city:
          type: string
          title: city / town
          minLength: 1
        county:
          type: string
          title: county / state
          minLength: 1
        country:
          type: string
          title: country
          minLength: 1
        postcode:
          type: string
          title: postcode / zipcode
          pattern: "^([A-Za-z][A-Ha-hJ-Yj-y]?[0-9][A-Za-z0-9]? ?[0-9][A-Za-z]{2}|[Gg][Ii][Rr] ?0[Aa]{2})$"

    Company:
      type: object
      required:
        - id
        - company_info
        - company_type
        - company_type_info
        - metadata
      properties:
        id:
          type: string
          title: company unique id
          readOnly: true
        company_info:
          type: object
          $ref: "#/components/schemas/CompanyInfo"
          title: company info
        users:
          type: array
          items:
            $ref: "#/components/schemas/UserType"
          title: users
        company_type:
          type: string
          enum:
            - limited_company
            - sole_trader
          title: company type
        company_type_info:
          type: object
          oneOf:
            - $ref: "#/components/schemas/LimitedCompanyInfo"
            - $ref: "#/components/schemas/SoleTraderInfo"
          title: company type info
        available_rates:
          type: array
          items:
            $ref: "#/components/schemas/AvailableRate"
          title: available rates
        metadata:
          type: object
          $ref: "#/components/schemas/Metadata"
          title: metadata
          readOnly: true

    CompanyInfo:
      type: object
      required:
        - trade_type
        - warranty_length
        - average_monthly_jobs
        - average_job_value
        - use_subcontractor
        - insurance_document
      properties:
        trade_type:
          type: string
          enum:
            - gas_engineer
            - electrician
            - ev_charger_installer
            - tiler
            - kitchen_fitter
            - floor_layer
            - cctv_and_security_installations
            - windows_and_doors
            - landscaping
            - air_conditioning
            - bathrooms
            - driveways_and_patios
            - garage_doors
            - fireplaces
            - multi_trade
            - other_trade
          title: trade type
        trade_body:
          type: string
          enum:
            - niceic
            - elecsa
            - gas_safe
            - napit
            - other
          title: trade body
        trade_body_number:
          type: string
          title: trade body number
          minLength: 1
        warranty_length:
          type: integer
          title: warranty length
          minimum: 1
        average_monthly_jobs:
          type: integer
          title: average monthly jobs
          minimum: 1
        average_job_value:
          type: integer
          title: average job value
          minimum: 1
        use_subcontractor:
          type: boolean
          title: use subcontractor?
        insurance_document:
          type: string
          format: base64
          title: insurance document

    LimitedCompanyInfo:
      type: object
      required:
        - company_name
        - company_address
        - trading_address
      properties:
        company_name:
          type: string
          title: company name
          minLength: 1
        company_address:
          type: object
          $ref: "#/components/schemas/Address"
          title: company address
        trading_address:
          type: object
          $ref: "#/components/schemas/Address"
          title: trading address

    SoleTraderInfo:
      type: object
      required:
        - national_insurance_number
        - trading_name
        - trading_address
      properties:
        national_insurance_number:
          type: string
          title: national insurance number
          minLength: 1
        trading_name:
          type: string
          title: trading name
          minLength: 1
        trading_address:
          type: object
          $ref: "#/components/schemas/Address"
          title: trading address

    DirectorInfo:
      type: object
      required:
        - verification_status
        - home_address
      properties:
        verification_status:
          type: string
          enum:
            - not_verified
            - verified
          title: verification status
          readOnly: true
        home_address:
          type: object
          $ref: "#/components/schemas/Address"
          title: home address

    UserType:
      type: object
      required:
        - role
        - first_name
        - email
        - mobile
      properties:
        director_info:
          type: object
          $ref: "#/components/schemas/DirectorInfo"
          title: director info
        role:
          type: string
          enum:
            - company-admin
            - company-manager
            - company-staff
          title: company role
        first_name:
          type: string
          title: first name
          minLength: 1
        last_name:
          type: string
          title: last name
          minLength: 1
        email:
          type: string
          format: email
          title: email
        mobile:
          type: string
          title: mobile
          minLength: 1

    AvailableRate:
      type: object
      required:
        - name
        - fee
        - enabled
      properties:
        name:
          type: string
          title: name
        fee:
          type: integer
          title: fee
          minimum: 0
        enabled:
          type: boolean
          title: enabled?

    Customer:
      type: object
      required:
        - first_name
        - email
        - phone
        - address
      properties:
        first_name:
          type: string
          title: first name
          minLength: 1
        last_name:
          type: string
          title: last name
          minLength: 1
        email:
          type: string
          format: email
          title: email
        phone:
          type: string
          title: phone number
          minLength: 1
        address:
          type: object
          $ref: "#/components/schemas/Address"

    PaymentMethod:
      type: string
      enum:
        - card
        - direct_debit
      title: payment method

    Job:
      type: object
      required:
        - id
        - cid
        - oid
        - title
        - description
        - deposit_type
        - deposit_value
        - customer
        - payment_methods
        - metadata
      properties:
        id:
          type: string
          title: job id
          readOnly: true
        cid:
          type: string
          title: company id
          readOnly: true
        oid:
          type: string
          title: owner id
          readOnly: true
        title:
          type: string
          title: job title
          minLength: 1
        description:
          type: string
          title: job description
          minLength: 1
        deposit_type:
          type: string
          title: deposit type
          minLength: 1
        deposit_value:
          type: integer
          format: int32
          title: deposit value in pence
          minimum: 1
        customer:
          type: object
          $ref: "#/components/schemas/Customer"
        payment_methods:
          type: array
          items:
            $ref: "#/components/schemas/PaymentMethod"
          title: payment methods
        payments:
          type: array
          items:
            $ref: "#/components/schemas/Payment"
          title: payments
        job_items:
          type: array
          items:
            $ref: "#/components/schemas/JobItem"
          title: job items
        notes:
          type: array
          items:
            type: string
          title: job notes
        metadata:
          type: object
          $ref: "#/components/schemas/Metadata"
          title: metadata
          readOnly: true

    Payment:
      type: object
      required:
        - id
        - kid
        - kind
        - xid
        - provider
        - status
        - amount
        - metadata
      properties:
        id:
          type: string
          title: payment id
          readOnly: true
        kid:
          type: string
          title: internal kind id
        kind:
          type: string
          title: internal kind
          enum:
            - job
            - job_payout
            - job_refund
            - charge
            - charge_refund
        xid:
          type: string
          title: external reference id
          readyOnly: true
        provider:
          type: string
          enum:
            - stripe
            - gocardless
            - bank_transfer
        status:
          type: string
          title: payment status
          enum:
            - unpaid
            - pending
            - paid
            - dispute
            - refunded
        amount:
          type: integer
          format: int32
          title: payment amount in pence
          minimum: 0
        metadata:
          type: object
          $ref: "#/components/schemas/Metadata"
          title: metadata
          readOnly: true

    JobItem:
      type: object
      properties:
        title:
          type: string
          title: job item title
          minLength: 1
        description:
          type: string
          title: job item description
          minLength: 1
        quantity:
          type: integer
          format: int32
          title: job item quantity
          minimum: 1
        price:
          type: integer
          format: int32
          title: job item total price in pence (vat inclusive)
          minimum: 1
        vat:
          type: integer
          format: int32
          title: job item vat value in pence

    Error:
      type: object
      required:
        - message
      properties:
        code:
          type: integer
          format: int32
          title: code
        message:
          type: string
          title: message
